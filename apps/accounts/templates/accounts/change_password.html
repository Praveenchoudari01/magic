{% extends base_template %}
{% block title %}Change Password{% endblock %}

{% block content %}
<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    background-color: #f8f9fa;
    display: flex;
    flex-direction: column;
  }

  main.page-main {
    flex: 1; /* takes all remaining vertical space */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    box-sizing: border-box;
  }

  .card-centered {
    width: 100%;
    max-width: 420px;
    padding: 2rem 1.5rem;
    border-radius: 18px;
    background: #ffffff;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    box-sizing: border-box;
  }

  h1.gradient-title {
    text-align: center;
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 1.25rem;
    background: linear-gradient(90deg, #6a11cb, #2575fc);
    -webkit-background-clip: text;
    color: transparent;
  }

  .form-control {
    border-radius: 10px;
    border: 1px solid #d1d5db;
    padding-right: 2.5rem;
    font-size: 0.95rem;
  }

  .position-relative .toggle-eye {
    position: absolute;
    right: 0.8rem;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #6b7280;
  }

  .btn-update {
    width: 100%;
    padding: 0.9rem;
    border-radius: 12px;
    border: none;
    font-weight: 600;
    background: linear-gradient(90deg, #6a11cb, #2575fc);
    color: #fff;
    font-size: 1rem;
  }

  .strength-text,
  #passwordMatch {
    font-size: 0.85rem;
    color: #6b7280;
  }

  footer {
    text-align: center;
    font-size: 0.85rem;
    color: #ffffff;
    padding: 0.8rem 0;
  }

  /* Mobile adjustments */
  @media (max-width: 768px) {
    .card-centered {
      padding: 1.5rem 1.25rem;
      border-radius: 14px;
      max-width: 92%;
    }

    h1.gradient-title {
      font-size: 1.5rem;
    }

    .form-control {
      font-size: 0.92rem;
    }

    .btn-update {
      font-size: 0.95rem;
    }
  }

  /* For very small screens (like old phones) */
  @media (max-height: 580px) {
    main.page-main {
      align-items: flex-start;
      padding-top: 2rem;
      padding-bottom: 2rem;
    }

    .card-centered {
      margin-top: 0.5rem;
    }
  }
</style>

<main class="page-main">
  <div class="card-centered">
    <h1 class="gradient-title">Change Password</h1>

    {% if user.first_login %}
      <div class="alert alert-warning d-flex align-items-center mb-3 p-2 rounded"
           style="font-size:0.9rem; background:#fff4e5; color:#b45309;">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        You must update your password before accessing the dashboard
      </div>
    {% endif %}

    {% if feedback.error %}
      <div class="alert alert-danger mb-3 p-2 rounded" id="feedbackMessage"
           style="background:#ffe5e5; color:#b91c1c;">
        {{ feedback.error }}
      </div>
    {% endif %}

    {% if feedback.success %}
      <div class="alert alert-success mb-3 p-2 rounded" id="feedbackMessage"
           style="background:#e6f4ea; color:#166534;">
        {{ feedback.success }}
      </div>
    {% endif %}

    <form method="post" id="changePasswordForm" novalidate>
      {% csrf_token %}

      {% if not user.first_login %}
      <div class="mb-3 position-relative">
        <input type="password" name="current_password" id="current_password"
               placeholder="Current Password" required class="form-control">
        <span onclick="togglePassword('current_password', this)" class="toggle-eye">
          <i class="bi bi-eye-fill"></i>
        </span>
      </div>
      {% endif %}

      <div class="mb-3 position-relative">
        <input type="password" name="new_password" id="new_password"
               placeholder="New Password" required class="form-control">
        <span onclick="togglePassword('new_password', this)" class="toggle-eye" style="top: 30%;">
          <i class="bi bi-eye-fill"></i>
        </span>
        <div id="passwordStrengthText" class="strength-text">
          Use 8+ characters with letters, numbers & symbols.
        </div>
      </div>

      <div class="mb-3 position-relative">
        <input type="password" name="confirm_password" id="confirm_password"
               placeholder="Confirm Password" required class="form-control">
        <span onclick="togglePassword('confirm_password', this)" class="toggle-eye" id="eye-confirm-button">
          <i class="bi bi-eye-fill"></i>
        </span>
        <div id="passwordMatch"></div>
      </div>

      <button type="submit" class="btn-update">Update Password</button>
      
      <div class="mt-4 text-center">
            <a href="{% url 'client:client_home' %}" class="btn btn-outline-dark">Back to Dashboard</a>
        </div>
    </form>
  </div>
</main>

<script>
  (function() {
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    const passwordStrengthText = document.getElementById('passwordStrengthText');
    const passwordMatch = document.getElementById('passwordMatch');
    const submitBtn = document.querySelector('button[type="submit"]');
    const confirm_eye_icon = document.getElementById('eye-confirm-button');

    if (newPassword) {
      newPassword.addEventListener('input', () => {
        const pwd = newPassword.value || '';
        if (pwd.length === 0) {
          passwordStrengthText.textContent = 'Use 8+ characters with letters, numbers & symbols.';
          checkPasswordMatch();
          return;
        }

        let width = 0, color = '#ffffff', text = '';
        if (pwd.length >= 8) width += 25;
        if (/[A-Z]/.test(pwd)) width += 25;
        if (/[0-9]/.test(pwd)) width += 25;
        if (/[^A-Za-z0-9]/.test(pwd)) width += 25;

        if (width <= 25) { color = '#dc2626'; text = 'Weak'; }
        else if (width <= 75) { color = '#facc15'; text = 'Good'; }
        else { color = '#16a34a'; text = 'Strong'; }

        passwordStrengthText.textContent = `Strength: ${text}`;
        passwordStrengthText.style.color = color;
        checkPasswordMatch();
      });
    }

    if (confirmPassword) confirmPassword.addEventListener('input', checkPasswordMatch);

    function checkPasswordMatch() {
      if (!confirmPassword) return;
      if (confirmPassword.value.length === 0) {
        passwordMatch.textContent = '';
        submitBtn.disabled = false;
        confirm_eye_icon.style.top = "50%";
      } else if (newPassword.value === confirmPassword.value) {
        passwordMatch.textContent = 'Passwords match ✔';
        passwordMatch.style.color = '#16a34a';
        confirm_eye_icon.style.top = "30%";
        submitBtn.disabled = false;
      } else {
        passwordMatch.textContent = 'Passwords do not match ✖';
        passwordMatch.style.color = '#dc2626';
        confirm_eye_icon.style.top = "30%";
        submitBtn.disabled = true;
      }
    }

    window.togglePassword = function(id, iconElement) {
      const input = document.getElementById(id);
      const i = iconElement.querySelector('i');
      if (input.type === 'password') {
        input.type = 'text';
        i.className = 'bi bi-eye-slash-fill';
      } else {
        input.type = 'password';
        i.className = 'bi bi-eye-fill';
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      const msg = document.getElementById('feedbackMessage');
      if (msg) {
        setTimeout(() => {
          msg.style.transition = 'opacity 0.5s';
          msg.style.opacity = '0';
        }, 4000);
      }
    });
  })();
</script>
{% endblock %}
